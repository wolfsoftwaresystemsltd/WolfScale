# WolfScale Load Balancer Configuration for nginx
# ================================================
# 
# This config provides:
#   - Read queries load-balanced across all nodes
#   - Write queries forwarded to the leader
#   - Health checks to remove unhealthy nodes
#
# Install: sudo cp nginx-example.conf /etc/nginx/conf.d/wolfscale.conf
# Test: sudo nginx -t
# Reload: sudo systemctl reload nginx

# Upstream for the HTTP API (all nodes)
upstream wolfscale_api {
    # All WolfScale nodes - nginx will health check them
    server 10.0.0.1:8080 max_fails=3 fail_timeout=10s;
    server 10.0.0.2:8080 max_fails=3 fail_timeout=10s;
    server 10.0.0.3:8080 max_fails=3 fail_timeout=10s;
}

# Upstream for MySQL reads (all nodes - round robin)
upstream mysql_read {
    least_conn;  # Send to node with fewest connections
    server 10.0.0.1:3306 max_fails=3 fail_timeout=10s;
    server 10.0.0.2:3306 max_fails=3 fail_timeout=10s;
    server 10.0.0.3:3306 max_fails=3 fail_timeout=10s;
}

# Upstream for MySQL writes (leader only)
# NOTE: Update this when leader changes, or use WolfScale's built-in proxy
#       which automatically forwards writes to the leader
upstream mysql_write {
    server 10.0.0.1:3306;  # Leader node
    # Backup servers activate if primary is down
    server 10.0.0.2:3306 backup;
    server 10.0.0.3:3306 backup;
}

# HTTP API Load Balancer
server {
    listen 80;
    server_name wolfscale.example.com;

    location / {
        proxy_pass http://wolfscale_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Timeouts
        proxy_connect_timeout 5s;
        proxy_read_timeout 30s;
        proxy_send_timeout 30s;
    }

    # Health check endpoint
    location /health {
        proxy_pass http://wolfscale_api/status;
        proxy_connect_timeout 2s;
        proxy_read_timeout 2s;
    }
}

# MySQL Stream Proxy (requires nginx stream module)
# Enable with: load_module /usr/lib/nginx/modules/ngx_stream_module.so;
#
# stream {
#     # MySQL read endpoint (port 3307) - load balanced
#     server {
#         listen 3307;
#         proxy_pass mysql_read;
#         proxy_connect_timeout 5s;
#     }
#
#     # MySQL write endpoint (port 3308) - leader only  
#     server {
#         listen 3308;
#         proxy_pass mysql_write;
#         proxy_connect_timeout 5s;
#     }
# }
